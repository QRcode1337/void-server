name: E2E Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (all, native, docker)'
        required: false
        default: 'all'

env:
  NEO4J_PASSWORD: testpassword
  NODE_VERSION: '20'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci && cd client && npm ci

      - name: Lint client
        run: npm run lint --prefix client || true

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci && cd client && npm ci

      - name: Build client
        run: npm run build --prefix client
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: client/dist
          retention-days: 1

  e2e-tests:
    needs: [lint, build]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        mode: [native, docker]

    services:
      neo4j:
        image: neo4j:5-community
        env:
          NEO4J_AUTH: neo4j/${{ env.NEO4J_PASSWORD }}
        ports:
          - 7474:7474
          - 7687:7687
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

      ipfs:
        image: ipfs/kubo:latest
        ports:
          - 5001:5001
          - 8080:8080
        options: >-
          --health-cmd "ipfs id || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 20s

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: client-build
          path: client/dist

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create test data directory
        run: |
          mkdir -p data
          cp -r data_template/* data/
          cat > data/neo4j.json << 'EOF'
          {
            "uri": "bolt://localhost:7687",
            "user": "neo4j",
            "password": "${{ env.NEO4J_PASSWORD }}",
            "database": "neo4j"
          }
          EOF
          cat > data/ipfs.json << 'EOF'
          {
            "enabled": true,
            "gateway": "http://localhost:8080/ipfs",
            "apiUrl": "http://localhost:5001",
            "publicGateway": "https://gateway.pinata.cloud/ipfs"
          }
          EOF
          cat > data/ai-providers.json << 'EOF'
          {
            "activeProvider": "lmstudio",
            "providers": {
              "lmstudio": {
                "name": "LM Studio (Mock)",
                "type": "api",
                "enabled": true,
                "endpoint": "http://localhost:1234/v1",
                "apiKey": "test-key"
              }
            }
          }
          EOF

      - name: Build LM Studio mock
        run: |
          cd tests/e2e/mocks/lmstudio
          npm install
          node server.js &
          sleep 2

      - name: Start application
        run: |
          NODE_ENV=production PORT=4401 node server/index.js &
          sleep 5
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_PASSWORD: ${{ env.NEO4J_PASSWORD }}
          IPFS_API_URL: http://localhost:5001

      - name: Wait for app
        run: npx wait-on http://localhost:4401/health -t 30000

      - name: Run Cucumber tests
        run: npm run test:ci
        env:
          TEST_ENV: ci
          USE_MOCKS: 'true'

      - name: Run Playwright tests
        run: npm run test:e2e || true
        env:
          TEST_ENV: ${{ matrix.mode }}
          CI: 'true'

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.mode }}
          path: |
            tests/e2e/reports/
            playwright-report/
          retention-days: 14

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots-${{ matrix.mode }}
          path: tests/e2e/reports/screenshots/
          retention-days: 7
