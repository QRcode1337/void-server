/**
 * Vite Plugin: Discover Plugins
 *
 * Scans the plugins directory at build time and generates a virtual module
 * that exports all plugin client components for dynamic loading.
 *
 * Usage in code:
 *   import { pluginModules } from 'virtual:plugins';
 *   const PluginComponent = pluginModules['void-plugin-verify'];
 */

import fs from 'fs';
import path from 'path';

const VIRTUAL_MODULE_ID = 'virtual:plugins';
const RESOLVED_VIRTUAL_MODULE_ID = '\0' + VIRTUAL_MODULE_ID;

export default function discoverPlugins(options = {}) {
  const pluginsDir = options.pluginsDir || path.resolve(process.cwd(), '../plugins');

  return {
    name: 'discover-plugins',

    resolveId(id) {
      if (id === VIRTUAL_MODULE_ID) {
        return RESOLVED_VIRTUAL_MODULE_ID;
      }
    },

    load(id) {
      if (id !== RESOLVED_VIRTUAL_MODULE_ID) return null;

      // Scan plugins directory
      const plugins = [];

      if (fs.existsSync(pluginsDir)) {
        const entries = fs.readdirSync(pluginsDir, { withFileTypes: true });

        for (const entry of entries) {
          if (!entry.name.startsWith('void-plugin-')) continue;

          const pluginPath = path.join(pluginsDir, entry.name);
          let realPath = pluginPath;

          // Follow symlinks
          if (fs.lstatSync(pluginPath).isSymbolicLink()) {
            realPath = fs.realpathSync(pluginPath);
          }

          // Check if it's a valid plugin with client entry
          const manifestPath = path.join(realPath, 'manifest.json');
          if (!fs.existsSync(manifestPath)) continue;

          const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
          const clientEntry = manifest.client?.entry;

          if (!clientEntry) continue;

          const clientEntryPath = path.join(realPath, clientEntry);
          if (!fs.existsSync(clientEntryPath)) continue;

          plugins.push({
            name: entry.name,
            clientEntry: clientEntryPath,
            manifest
          });
        }
      }

      // Generate the virtual module code
      const imports = plugins.map((p, i) =>
        `import * as plugin${i} from '${p.clientEntry.replace(/\\/g, '/')}';`
      ).join('\n');

      const moduleMap = plugins.map((p, i) =>
        `  '${p.name}': plugin${i}`
      ).join(',\n');

      const manifestMap = plugins.map(p =>
        `  '${p.name}': ${JSON.stringify(p.manifest)}`
      ).join(',\n');

      const code = `
// Auto-generated by vite-plugin-discover-plugins
// Do not edit manually

${imports}

export const pluginModules = {
${moduleMap}
};

export const pluginManifests = {
${manifestMap}
};

export const pluginNames = ${JSON.stringify(plugins.map(p => p.name))};
`;

      return code;
    },

    // Trigger rebuild when plugins directory changes (dev mode)
    configureServer(server) {
      server.watcher.add(pluginsDir);
      server.watcher.on('all', (event, filePath) => {
        if (filePath.includes(pluginsDir)) {
          // Invalidate the virtual module to trigger re-generation
          const mod = server.moduleGraph.getModuleById(RESOLVED_VIRTUAL_MODULE_ID);
          if (mod) {
            server.moduleGraph.invalidateModule(mod);
            server.ws.send({ type: 'full-reload' });
          }
        }
      });
    }
  };
}
